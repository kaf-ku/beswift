$(document).ready(function(){$("#newGame").modal({dismissible:!1}),$("#newGame").modal("open"),$("#newGameBtn").focus()}),loadHighScores();let highScoreMin;function loadHighScores(){$.ajax({url:'https://api.mlab.com/api/1/databases/tetrishighscores/collections/scores?s={"score":-1}&apiKey=E8dx03lqLdc5pG_K002t_lJrPOwDi1vG',type:"GET",success(e){let r='<p class="score-title"><u>High Scores:</u></p>';highScoreMin=e[10].score;for(var a=0;a<=10;a++)r+=`<p>${e[a].name.slice(0,7)}: ${e[a].score}</p>`;$(".highScores").html(r)},error(e,r,a){console.log(a)}})}let pause=!0;const canvas=document.querySelector(".tetris"),context=canvas.getContext("2d"),nextCanvas=document.querySelector(".next"),nextContext=nextCanvas.getContext("2d");context.scale(20,20),nextContext.scale(30,30);const arena=createMatrix(12,20),nextArena=createMatrix(6,6),player={pos:{x:0,y:0},matrix:null,score:0,level:1,dropInterval:1e3,DROP_SLOW:100,next:null};let dropCounter=0,DROP_FAST=50;function arenaSweep(){let e=1;outer:for(y=arena.length-1;y>0;y--){for(x=0;x<arena[y].length;x++)if(0===arena[y][x])continue outer;let r=arena.splice(y,1)[0].fill(0);arena.unshift(r),y++,player.score+=100*e,e*=2;let a=player.score.toString();if(a.length>3){let t=Number(a.slice(0,a.length-3));player.level=t+1,player.dropInterval=1e3-50*t,player.DROP_SLOW=1e3-50*t}}}function collide(e,r){let[a,t]=[r.matrix,r.pos];for(y=0;y<a.length;y++)for(x=0;x<a[y].length;x++)if(0!==a[y][x]&&0!==(e[y+t.y]&&e[y+t.y][x+t.x]))return!0;return!1}function createMatrix(e,r){let a=[];for(;r--;)a.push(Array(e).fill(0));return a}function createPiece(e){if("I"===e)return[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]];if("J"===e)return[[0,2,0],[0,2,0],[2,2,0]];if("L"===e)return[[0,3,0],[0,3,0],[0,3,3]];if("O"===e)return[[4,4],[4,4]];if("S"===e)return[[0,5,5],[5,5,0],[0,0,0]];else if("T"===e)return[[0,0,0],[6,6,6],[0,6,0]];else if("Z"===e)return[[7,7,0],[0,7,7],[0,0,0]]}function drawNext(){nextContext.fillStyle="#000",nextContext.fillRect(0,0,nextCanvas.width,nextCanvas.height),drawMatrix(nextArena,{x:0,y:0},nextContext),drawMatrix(player.next,{x:1,y:1},nextContext)}function draw(){context.fillStyle="#000",context.fillRect(0,0,canvas.width,canvas.height),drawMatrix(arena,{x:0,y:0},context),drawMatrix(player.matrix,player.pos,context)}function drawMatrix(e,r,a){e.forEach((e,t)=>{e.forEach((e,l)=>{0!==e&&(a.fillStyle=colors[e],a.fillRect(l+r.x,t+r.y,1,1))})})}function merge(e,r){r.matrix.forEach((a,t)=>{a.forEach((a,l)=>{0!==a&&(e[t+r.pos.y][l+r.pos.x]=a)})})}function playerDrop(){player.pos.y++,collide(arena,player)&&(player.pos.y--,merge(arena,player),playerReset(),arenaSweep(),updateScore()),dropCounter=0}function playerMove(e){player.pos.x+=e,collide(arena,player)&&(player.pos.x-=e)}function playerReset(){let e="IJLOSTZ";null===player.next?(player.matrix=createPiece(e[e.length*Math.random()|0]),player.next=createPiece(e[e.length*Math.random()|0])):(player.matrix=player.next,player.next=createPiece(e[e.length*Math.random()|0])),drawNext(),player.pos.y=0,player.pos.x=(arena[0].length/2|0)-(player.matrix[0].length/2|0),collide(arena,player)&&(pauseGame(),document.removeEventListener("keydown",keyListener),document.removeEventListener("keyup",keyListener))}function clearPlayer(){player.dropInterval=1e3,player.DROP_SLOW=1e3,player.score=0,player.level=1,arena.forEach(e=>e.fill(0)),updateScore()}function playerRotate(e){let r=player.pos.x,a=1;for(rotate(player.matrix,e);collide(arena,player);)if(player.pos.x+=a,(a=-(a+(a>0?1:-1)))>player.matrix[0].length){rotate(player.matrix,-e),player.pos.x=r;return}}function rotate(e,r){for(y=0;y<e.length;y++)for(x=0;x<y;x++)[e[x][y],e[y][x],]=[e[y][x],e[x][y],];r>0?e.forEach(e=>e.reverse()):e.reverse()}let lastTime=0;function update(e=0){if($("#pause").off(),pause)draw();else{let r=e-lastTime;lastTime=e,(dropCounter+=r)>player.dropInterval&&playerDrop(),draw(),requestAnimationFrame(update)}}function updateScore(){document.querySelector(".score").innerHTML=`<p><b><u>Score:</u> ${player.score}</b></p>`,document.querySelector(".level").innerHTML=`<p><b><u>Level:</u> ${player.level}</b></p>`}const colors=[null,"#03A9F4","#9C27B0","#FFC107","#E91E63","#00BCD4","#8BC34A","#3F51B5"];function keyListener(e){"keydown"===e.type&&(37===e.keyCode?playerMove(-1):39===e.keyCode?playerMove(1):81===e.keyCode?playerRotate(-1):87===e.keyCode||38===e.keyCode?playerRotate(1):27===e.keyCode&&pauseGame()),40===e.keyCode&&("keydown"===e.type?player.dropInterval!==DROP_FAST&&(playerDrop(),player.dropInterval=DROP_FAST):player.dropInterval=player.DROP_SLOW)}function pauseGame(){!0===pause?(pause=!1,$("#pause").modal({onCloseStart:update()}),$("#pause").modal("close")):collide(arena,player)?(pause=!0,player.score>0?($("#gameOver").modal({dismissible:!1,onOpenEnd:function(){$("#name").focus()}}),$("#gameOver").modal("open"),$(".yourScore").html(`<p>Your Score: ${player.score}`)):($("#newGame").modal({dismissible:!1}),$("#newGame").modal("open"))):(pause=!0,document.createEventListener,$("#pause").modal({dismissible:!1,onCloseStart:update()}),$("#pause").modal("open"),$("#pauseBtn").focus(),$("body").on("keydown",e=>{39===e.keyCode&&$("#StartNewBtn").focus(),37===e.keyCode&&$("#pauseBtn").focus()}))}function newGame(){loadHighScores(),clearPlayer(),pause=!1,playerReset(),update(),updateScore(),document.addEventListener("keydown",keyListener),document.addEventListener("keyup",keyListener)}$("#highScore").on("submit",e=>{e.preventDefault();let r=$("#name").val();$.ajax({url:"https://api.mlab.com/api/1/databases/tetrishighscores/collections/scores?apiKey=E8dx03lqLdc5pG_K002t_lJrPOwDi1vG",data:JSON.stringify({date:new Date,name:r,score:player.score,level:player.level}),type:"POST",contentType:"application/json",success(e){$("#highScore").html("<h4>Thank You!</h4>")},error(e,r,a){console.log(a)}})}),update();